<script>
  // ... keep your existing variables (APP_URL, form, etc.)

  // Generate a simple UUID
  function genId(){
    return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
      (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
    );
  }

  // JSONP helper (bypass CORS)
  function jsonp(url, cbName){
    return new Promise((resolve)=>{
      const script = document.createElement('script');
      const callback = cbName || ('cb_' + Math.random().toString(36).slice(2));
      window[callback] = (data)=>{ resolve(data); document.body.removeChild(script); delete window[callback]; };
      script.src = url + (url.includes('?') ? '&' : '?') + 'callback=' + callback;
      document.body.appendChild(script);
    });
  }

  // Poll staff check
  async function waitForStaffCheck(submissionId, onUpdate){
    // poll every 3s up to 2 minutes
    const deadline = Date.now() + 120000;
    while (Date.now() < deadline){
      const url = APP_URL + '?status=1&id=' + encodeURIComponent(submissionId);
      const res = await jsonp(url);
      if (res && res.ok && res.found){
        const val = String(res.staffCheck || '').trim().toLowerCase();
        if (val){ // staff typed something
          onUpdate(val);
          return;
        }
      }
      await new Promise(r=>setTimeout(r, 3000));
    }
    onUpdate(''); // timeout -> treat as not correct yet
  }

  // ----- submit handler (replace your existing one) -----
  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    show(statusBox, false);
    submitBtn.disabled = true;

    const submissionId = genId();
    const payload = {
      location: document.getElementById('loc').value.trim(),
      suspect:  document.getElementById('suspect').value.trim(),
      reporter: document.getElementById('reporter').value.trim(),
      client_ts: new Date().toISOString(),
      submissionId
    };

    if(!payload.location || !payload.suspect || !payload.reporter){
      setStatus(false, 'Please complete all fields.');
      submitBtn.disabled = false; return;
    }

    try {
      // Write row (no-cors POST)
      await fetch(APP_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify(payload),
        mode: 'no-cors'
      });

      // Let the player know we are waiting for staff check
      setStatus(true, 'Submitted. Waiting for staff check…');

      // Start polling StaffCheck
      await waitForStaffCheck(submissionId, (val)=>{
        if (val === 'correct') {
          setStatus(true, '✅ correct — mission clear');
        } else {
          setStatus(false, '❌ location and suspect incorrect');
        }
      });

    } catch (err) {
      setStatus(false, 'Network error. Please try again.');
    } finally {
      submitBtn.disabled = false;
      form.reset();
    }
  });
</script>
